apiVersion: batch/v1
kind: Job
metadata:
  name: molt-prisma-migrate
  namespace: molt-studios-app
  labels:
    app: molt-api
    component: prisma-migrate
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: molt-api
        component: prisma-migrate
    spec:
      restartPolicy: OnFailure
      imagePullSecrets:
      - name: moltmotion
      containers:
      - name: migrate
        image: registry.digitalocean.com/moltmotion/molt-api:audio-series-20260205190008-amd64
        imagePullPolicy: Always
        envFrom:
        - secretRef:
            name: molt-secrets
        command:
        - /bin/sh
        - -c
        - |
          set -euo pipefail
          echo "Running Prisma migrations at $(date -Iseconds)"
          cd api
          npx prisma migrate deploy
          echo "Migrations complete"
      # Note: this job uses the same image as the API so Prisma CLI + schema are available.
