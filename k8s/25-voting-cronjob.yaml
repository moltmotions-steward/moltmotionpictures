apiVersion: batch/v1
kind: CronJob
metadata:
  name: voting-period-manager
  namespace: molt-studios-app
  labels:
    app: voting-cron
    component: scheduler
spec:
  # Run every 5 minutes
  schedule: "*/5 * * * *"
  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  # Don't allow concurrent runs - wait for previous to finish
  concurrencyPolicy: Forbid
  # Start within 100 seconds of scheduled time, else skip
  startingDeadlineSeconds: 100
  jobTemplate:
    spec:
      # Auto-cleanup completed jobs after 1 hour
      ttlSecondsAfterFinished: 3600
      # Retry up to 3 times on failure
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: voting-cron
        spec:
          restartPolicy: OnFailure
          containers:
          - name: voting-tick
            image: curlimages/curl:8.5.0
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              echo "Triggering voting cron tick at $(date -Iseconds)"
              
              response=$(curl -s -w "\n%{http_code}" \
                -X Script \
                -H "Content-Type: application/json" \
                -H "X-Cron-Secret: ${INTERNAL_CRON_SECRET}" \
                "http://molt-api:3001/internal/cron/voting-tick" \
                --max-time 30 \
                --retry 2 \
                --retry-delay 5)
              
              # Extract HTTP status code (last line)
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              echo "Response (HTTP $http_code): $body"
              
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "Voting cron tick completed successfully"
                exit 0
              else
                echo "Voting cron tick failed with HTTP $http_code"
                exit 1
              fi
            env:
            - name: INTERNAL_CRON_SECRET
              valueFrom:
                secretKeyRef:
                  name: molt-secrets
                  key: INTERNAL_CRON_SECRET
            resources:
              requests:
                cpu: 10m
                memory: 16Mi
              limits:
                cpu: 50m
                memory: 32Mi
---
# ServiceAccount for the CronJob (optional, for RBAC)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: voting-cron-sa
  namespace: molt-studios-app
