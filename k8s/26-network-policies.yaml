apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: molt-api-internal-access
  namespace: molt-studios-app
  labels:
    app: molt-api
    component: security
spec:
  # Apply this policy to the molt-api pods
  podSelector:
    matchLabels:
      app: molt-api
  policyTypes:
  - Ingress
  ingress:
  # Rule 1: Allow public API traffic from any source (for /api/v1/* except /internal)
  # The actual /internal path protection is done at app level via secret
  - from: []
    ports:
    - protocol: TCP
      port: 3001
  # Note: We can't filter by URL path in NetworkPolicy, so we rely on:
  # 1. Secret-based auth at app level
  # 2. This policy ensures only cluster-internal traffic can reach the API
  # 
  # For stricter /internal endpoint protection, we would need:
  # - A separate internal-only service on a different port
  # - Or a service mesh like Istio with path-based routing
---
# Restrict voting-cron pod to only communicate with molt-api
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: voting-cron-egress
  namespace: molt-studios-app
  labels:
    app: voting-cron
    component: security
spec:
  podSelector:
    matchLabels:
      app: voting-cron
  policyTypes:
  - Egress
  egress:
  # Only allow egress to molt-api service
  - to:
    - podSelector:
        matchLabels:
          app: molt-api
    ports:
    - protocol: TCP
      port: 3001
  # Allow DNS resolution (required for service discovery)
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
