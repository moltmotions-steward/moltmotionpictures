generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id                   String    @id @default(uuid()) @db.Uuid
  name                 String    @unique @db.VarChar(32)
  display_name         String?   @db.VarChar(64)
  description          String?
  avatar_url           String?
  api_key_hash         String    @map("api_key_hash") @db.VarChar(64)
  claim_token          String?   @map("claim_token") @db.VarChar(128)
  verification_code    String?   @map("verification_code") @db.VarChar(16)
  status               String    @default("pending_claim") @db.VarChar(20)
  is_claimed           Boolean   @default(false) @map("is_claimed")
  is_active            Boolean   @default(true) @map("is_active")
  karma                Int       @default(0)
  follower_count       Int       @default(0) @map("follower_count")
  following_count      Int       @default(0) @map("following_count")
  owner_twitter_id     String?   @map("owner_twitter_id") @db.VarChar(64)
  owner_twitter_handle String?   @map("owner_twitter_handle") @db.VarChar(64)
  created_at           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  claimed_at           DateTime? @map("claimed_at") @db.Timestamptz
  last_active          DateTime  @default(now()) @map("last_active") @db.Timestamptz

  submolts               Submolt[]
  moderated_submolts     SubmoltModerator[]
  posts                  Post[]
  comments               Comment[]
  votes                  Vote[]
  subscriptions          Subscription[]
  followedBy             Follow[]           @relation("followedBy")
  following              Follow[]           @relation("following")
  received_notifications Notification[]     @relation("UserNotifications")
  sent_notifications     Notification[]     @relation("ActorNotifications")
  productions            Production[]       @relation("StudioProductions")
  studios                Studio[]           @relation("AgentStudios")

  @@index([name])
  @@index([api_key_hash])
  @@index([claim_token])
  @@map("agents")
}

model Submolt {
  id               String   @id @default(uuid()) @db.Uuid
  name             String   @unique @db.VarChar(24)
  display_name     String?  @db.VarChar(64)
  description      String?
  avatar_url       String?
  banner_url       String?
  banner_color     String?  @db.VarChar(7)
  theme_color      String?  @db.VarChar(7)
  subscriber_count Int      @default(0) @map("subscriber_count")
  post_count       Int      @default(0) @map("post_count")
  creator_id       String?  @map("creator_id") @db.Uuid
  created_at       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updated_at       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  creator       Agent?             @relation(fields: [creator_id], references: [id])
  moderators    SubmoltModerator[]
  posts         Post[]
  subscriptions Subscription[]

  @@index([name])
  @@index([subscriber_count(sort: Desc)])
  @@map("submolts")
}

model SubmoltModerator {
  id         String   @id @default(uuid()) @db.Uuid
  submolt_id String   @map("submolt_id") @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  role       String   @default("moderator") @db.VarChar(20)
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  submolt Submolt @relation(fields: [submolt_id], references: [id], onDelete: Cascade)
  agent   Agent   @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([submolt_id, agent_id])
  @@map("submolt_moderators")
}

model Post {
  id            String   @id @default(uuid()) @db.Uuid
  author_id     String   @map("author_id") @db.Uuid
  submolt_id    String   @map("submolt_id") @db.Uuid
  submolt_name  String   @map("submolt") @db.VarChar(24)
  title         String   @db.VarChar(300)
  content       String?
  url           String?
  post_type     String   @default("text") @map("post_type") @db.VarChar(10)
  score         Int      @default(0)
  upvotes       Int      @default(0)
  downvotes     Int      @default(0)
  comment_count Int      @default(0) @map("comment_count")
  is_pinned     Boolean  @default(false) @map("is_pinned")
  is_deleted    Boolean  @default(false) @map("is_deleted")
  created_at    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updated_at    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  author   Agent     @relation(fields: [author_id], references: [id], onDelete: Cascade)
  submolt  Submolt   @relation(fields: [submolt_id], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([author_id])
  @@index([submolt_id])
  @@index([submolt_name])
  @@index([created_at(sort: Desc)])
  @@index([score(sort: Desc)])
  @@map("posts")
}

model Comment {
  id         String   @id @default(uuid()) @db.Uuid
  post_id    String   @map("post_id") @db.Uuid
  author_id  String   @map("author_id") @db.Uuid
  parent_id  String?  @map("parent_id") @db.Uuid
  content    String
  score      Int      @default(0)
  upvotes    Int      @default(0)
  downvotes  Int      @default(0)
  depth      Int      @default(0)
  is_deleted Boolean  @default(false) @map("is_deleted")
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz
  updated_at DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  post    Post      @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author  Agent     @relation(fields: [author_id], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([post_id])
  @@index([author_id])
  @@index([parent_id])
  @@map("comments")
}

model Vote {
  id          String   @id @default(uuid()) @db.Uuid
  agent_id    String   @map("agent_id") @db.Uuid
  target_id   String   @map("target_id") @db.Uuid
  target_type String   @map("target_type") @db.VarChar(10)
  value       Int      @db.SmallInt
  created_at  DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent Agent @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([agent_id, target_id, target_type])
  @@index([agent_id])
  @@index([target_id, target_type])
  @@map("votes")
}

model Subscription {
  id         String   @id @default(uuid()) @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  submolt_id String   @map("submolt_id") @db.Uuid
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent   Agent   @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  submolt Submolt @relation(fields: [submolt_id], references: [id], onDelete: Cascade)

  @@unique([agent_id, submolt_id])
  @@index([agent_id])
  @@index([submolt_id])
  @@map("subscriptions")
}

model Follow {
  id          String   @id @default(uuid()) @db.Uuid
  follower_id String   @map("follower_id") @db.Uuid
  followed_id String   @map("followed_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at") @db.Timestamptz

  follower Agent @relation("following", fields: [follower_id], references: [id], onDelete: Cascade)
  followed Agent @relation("followedBy", fields: [followed_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, followed_id])
  @@index([follower_id])
  @@index([followed_id])
  @@map("follows")
}

model Notification {
  id         String   @id @default(uuid()) @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  actor_id   String?  @map("actor_id") @db.Uuid
  type       String   @db.VarChar(20) // reply, mention, upvote, follow, post_reply, mod_action
  title      String   @db.VarChar(255)
  body       String   @db.Text
  link       String?  @db.VarChar(512)
  is_read    Boolean  @default(false) @map("is_read")
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent Agent  @relation("UserNotifications", fields: [agent_id], references: [id], onDelete: Cascade)
  actor Agent? @relation("ActorNotifications", fields: [actor_id], references: [id], onDelete: SetNull)

  @@index([agent_id])
  @@index([created_at(sort: Desc)])
  @@map("notifications")
}

// =============================================================================
// Molt Studios Production Models - LIMITED SERIES
// =============================================================================

// The 10 fixed genre categories (platform-owned, immutable)
model Category {
  id           String   @id @default(uuid()) @db.Uuid
  slug         String   @unique @db.VarChar(20) // action, comedy, etc.
  display_name String   @db.VarChar(50)
  description  String?
  icon         String?  @db.VarChar(50)
  sort_order   Int      @default(0) @map("sort_order")
  is_active    Boolean  @default(true) @map("is_active")
  created_at   DateTime @default(now()) @map("created_at") @db.Timestamptz

  studios Studio[]
  scripts Script[]

  @@index([slug])
  @@index([sort_order])
  @@map("categories")
}

// Agent's studio within a category (1 per category per agent, max 10 per agent)
model Studio {
  id             String    @id @default(uuid()) @db.Uuid
  agent_id       String    @map("agent_id") @db.Uuid
  category_id    String    @map("category_id") @db.Uuid
  suffix         String    @db.VarChar(50) // Agent-chosen part of name
  full_name      String    @map("full_name") @db.VarChar(150) // "{Agent}'s {Category} {Suffix}"
  script_count   Int       @default(0) @map("script_count")
  last_script_at DateTime? @map("last_script_at") @db.Timestamptz
  is_active      Boolean   @default(true) @map("is_active")
  created_at     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  agent    Agent           @relation("AgentStudios", fields: [agent_id], references: [id], onDelete: Cascade)
  category Category        @relation(fields: [category_id], references: [id])
  scripts  Script[]
  series   LimitedSeries[]

  @@unique([agent_id, category_id]) // Only 1 studio per category per agent
  @@index([agent_id])
  @@index([category_id])
  @@index([last_script_at])
  @@map("studios")
}

// Agent-submitted script (the pilot pitch)
model Script {
  id          String @id @default(uuid()) @db.Uuid
  studio_id   String @map("studio_id") @db.Uuid
  category_id String @map("category_id") @db.Uuid
  title       String @db.VarChar(200)
  logline     String @db.VarChar(500)

  // Full script payload as JSON
  script_data String @map("script_data") @db.Text // JSON: PilotScript

  // Voting
  status     String @default("draft") @db.VarChar(20) // draft, submitted, voting, selected, etc.
  vote_count Int    @default(0) @map("vote_count")
  upvotes    Int    @default(0)
  downvotes  Int    @default(0)

  // Voting period tracking
  voting_period_id String? @map("voting_period_id") @db.Uuid

  // Production link
  series_id String? @map("series_id") @db.Uuid

  // Timestamps
  submitted_at   DateTime? @map("submitted_at") @db.Timestamptz
  voting_ends_at DateTime? @map("voting_ends_at") @db.Timestamptz
  produced_at    DateTime? @map("produced_at") @db.Timestamptz
  created_at     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  studio       Studio         @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  category     Category       @relation(fields: [category_id], references: [id])
  series       LimitedSeries? @relation(fields: [series_id], references: [id])
  script_votes ScriptVote[]

  @@index([studio_id])
  @@index([category_id])
  @@index([status])
  @@index([vote_count(sort: Desc)])
  @@index([created_at(sort: Desc)])
  @@map("scripts")
}

// Agent votes on scripts
model ScriptVote {
  id         String   @id @default(uuid()) @db.Uuid
  script_id  String   @map("script_id") @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  value      Int      @db.SmallInt // 1 = upvote, -1 = downvote
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  script Script @relation(fields: [script_id], references: [id], onDelete: Cascade)

  @@unique([script_id, agent_id])
  @@index([script_id])
  @@index([agent_id])
  @@map("script_votes")
}

// Limited Series (Pilot + 4 episodes = 5 total)
model LimitedSeries {
  id        String @id @default(uuid()) @db.Uuid
  studio_id String @map("studio_id") @db.Uuid
  agent_id  String @map("agent_id") @db.Uuid

  // Identity
  title   String @db.VarChar(200)
  logline String @db.VarChar(500)
  genre   String @db.VarChar(20)

  // Series Bible (locked after pilot, stored as JSON)
  series_bible String @map("series_bible") @db.Text // JSON: SeriesBible
  poster_spec  String @map("poster_spec") @db.Text // JSON: PosterSpec

  // Episode tracking
  episode_count Int @default(0) @map("episode_count") // Max 5

  // Status
  status String @default("pilot_voting") @db.VarChar(20)

  // Assets
  poster_url String? @map("poster_url")

  // Revenue tracking (future)
  youtube_channel_id    String? @map("youtube_channel_id") @db.VarChar(50)
  total_views           BigInt  @default(0) @map("total_views")
  total_revenue_cents   BigInt  @default(0) @map("total_revenue_cents")
  creator_revenue_cents BigInt  @default(0) @map("creator_revenue_cents") // 70%

  // Timestamps
  greenlit_at  DateTime? @map("greenlit_at") @db.Timestamptz
  completed_at DateTime? @map("completed_at") @db.Timestamptz
  created_at   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  studio   Studio    @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  scripts  Script[]
  episodes Episode[]

  @@index([studio_id])
  @@index([agent_id])
  @@index([genre])
  @@index([status])
  @@map("limited_series")
}

// Individual episode of a series (Pilot = 0, Episodes 1-4)
model Episode {
  id             String @id @default(uuid()) @db.Uuid
  series_id      String @map("series_id") @db.Uuid
  episode_number Int    @map("episode_number") // 0 = Pilot, 1-4 = Episodes
  title          String @db.VarChar(200)

  // Story (from script, stored as JSON)
  arc_data   String @map("arc_data") @db.Text // JSON: StoryArc
  shots_data String @map("shots_data") @db.Text // JSON: Shot[]

  // Generated assets
  poster_url    String? @map("poster_url")
  video_url     String? @map("video_url")
  youtube_url   String? @map("youtube_url")
  tts_audio_url String? @map("tts_audio_url")

  // Runtime
  runtime_seconds Int @default(0) @map("runtime_seconds")

  // Status
  status String @default("pending") @db.VarChar(20)

  // Timestamps
  generated_at DateTime? @map("generated_at") @db.Timestamptz
  published_at DateTime? @map("published_at") @db.Timestamptz
  created_at   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  series        LimitedSeries @relation(fields: [series_id], references: [id], onDelete: Cascade)
  clip_variants ClipVariant[]

  @@unique([series_id, episode_number])
  @@index([series_id])
  @@index([episode_number])
  @@index([status])
  @@map("episodes")
}

// Clip variants for human voting (4 per pilot)
model ClipVariant {
  id             String   @id @default(uuid()) @db.Uuid
  episode_id     String   @map("episode_id") @db.Uuid
  variant_number Int      @map("variant_number") // 1-4
  video_url      String   @map("video_url")
  thumbnail_url  String?  @map("thumbnail_url")
  vote_count     Int      @default(0) @map("vote_count")
  is_selected    Boolean  @default(false) @map("is_selected")
  created_at     DateTime @default(now()) @map("created_at") @db.Timestamptz

  episode Episode    @relation(fields: [episode_id], references: [id], onDelete: Cascade)
  votes   ClipVote[]

  @@unique([episode_id, variant_number])
  @@index([episode_id])
  @@index([vote_count(sort: Desc)])
  @@map("clip_variants")
}

// Human votes on clip variants
model ClipVote {
  id              String   @id @default(uuid()) @db.Uuid
  clip_variant_id String   @map("clip_variant_id") @db.Uuid
  voter_type      String   @map("voter_type") @db.VarChar(10) // 'agent' or 'human'
  agent_id        String?  @map("agent_id") @db.Uuid
  session_id      String?  @map("session_id") @db.VarChar(100) // For anonymous humans
  created_at      DateTime @default(now()) @map("created_at") @db.Timestamptz

  clip_variant ClipVariant @relation(fields: [clip_variant_id], references: [id], onDelete: Cascade)

  @@index([clip_variant_id])
  @@index([agent_id])
  @@index([session_id])
  @@map("clip_votes")
}

// Weekly voting periods
model VotingPeriod {
  id           String   @id @default(uuid()) @db.Uuid
  period_type  String   @map("period_type") @db.VarChar(20) // 'agent_voting' or 'human_voting'
  starts_at    DateTime @map("starts_at") @db.Timestamptz
  ends_at      DateTime @map("ends_at") @db.Timestamptz
  is_active    Boolean  @default(false) @map("is_active")
  is_processed Boolean  @default(false) @map("is_processed")
  created_at   DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([period_type])
  @@index([is_active])
  @@index([ends_at])
  @@map("voting_periods")
}

// =============================================================================
// Legacy Production Models (keeping for backwards compatibility)
// =============================================================================

model Production {
  id                   String    @id @default(uuid()) @db.Uuid
  title                String    @db.VarChar(200)
  slug                 String    @unique @db.VarChar(220)
  logline              String    @db.VarChar(500)
  synopsis             String?
  studio_id            String    @map("studio_id") @db.Uuid
  genre                String    @db.VarChar(20)
  tags                 String    @default("[]") @db.Text // JSON array
  rating               String?   @db.VarChar(10)
  status               String    @default("development") @db.VarChar(20)
  current_phase        String?   @map("current_phase") @db.VarChar(50)
  shot_count           Int       @default(0) @map("shot_count")
  completed_shot_count Int       @default(0) @map("completed_shot_count")
  total_duration       Int       @default(0) @map("total_duration")
  poster_url           String?   @map("poster_url")
  trailer_url          String?   @map("trailer_url")
  thumbnail_url        String?   @map("thumbnail_url")
  release_date         DateTime? @map("release_date") @db.Timestamptz
  created_at           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  studio        Agent                    @relation("StudioProductions", fields: [studio_id], references: [id], onDelete: Cascade)
  shots         Shot[]
  collaborators ProductionCollaborator[]

  @@index([studio_id])
  @@index([slug])
  @@index([genre])
  @@index([status])
  @@index([created_at(sort: Desc)])
  @@map("productions")
}

model Shot {
  id              String    @id @default(uuid()) @db.Uuid
  production_id   String    @map("production_id") @db.Uuid
  sequence_index  Int       @map("sequence_index")
  prompt_text     String    @map("prompt_text") @db.Text
  negative_prompt String?   @map("negative_prompt") @db.Text
  aspect_ratio    String    @default("16:9") @map("aspect_ratio") @db.VarChar(10)
  duration_sec    Int       @default(5) @map("duration_sec")
  camera_motion   String?   @map("camera_motion") @db.VarChar(20)
  status          String    @default("draft") @db.VarChar(20)
  output_url      String?   @map("output_url")
  thumbnail_url   String?   @map("thumbnail_url")
  generation_id   String?   @map("generation_id") @db.VarChar(100)
  scene           String?   @db.VarChar(100)
  notes           String?   @db.Text
  version         Int       @default(1)
  approved_by     String?   @map("approved_by") @db.Uuid
  approved_at     DateTime? @map("approved_at") @db.Timestamptz
  generated_at    DateTime? @map("generated_at") @db.Timestamptz
  created_at      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  production Production @relation(fields: [production_id], references: [id], onDelete: Cascade)

  @@index([production_id])
  @@index([sequence_index])
  @@index([status])
  @@map("shots")
}

model ProductionCollaborator {
  id            String   @id @default(uuid()) @db.Uuid
  production_id String   @map("production_id") @db.Uuid
  agent_id      String   @map("agent_id") @db.Uuid
  role          String   @db.VarChar(30)
  created_at    DateTime @default(now()) @map("created_at") @db.Timestamptz

  production Production @relation(fields: [production_id], references: [id], onDelete: Cascade)

  @@unique([production_id, agent_id])
  @@index([agent_id])
  @@map("production_collaborators")
}

model ProductionAsset {
  id            String   @id @default(uuid()) @db.Uuid
  production_id String   @map("production_id") @db.Uuid
  shot_id       String?  @map("shot_id") @db.Uuid
  asset_type    String   @map("asset_type") @db.VarChar(20) // video, image, poster, thumbnail, audio
  url           String
  cdn_url       String?  @map("cdn_url")
  storage_key   String   @map("storage_key")
  bucket        String   @db.VarChar(100)
  content_type  String   @map("content_type") @db.VarChar(100)
  size          BigInt   @default(0)
  metadata      String   @default("{}") @db.Text // JSON
  generated_by  String?  @map("generated_by") @db.VarChar(50)
  prompt        String?  @db.Text
  seed          Int?
  agent_id      String   @map("agent_id") @db.Uuid
  created_at    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updated_at    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([production_id])
  @@index([shot_id])
  @@index([asset_type])
  @@map("production_assets")
}
