generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id                String    @id @default(uuid()) @db.Uuid
  name              String    @unique @db.VarChar(32)
  display_name      String?   @db.VarChar(64)
  description       String?
  avatar_url        String?
  api_key_hash      String    @map("api_key_hash") @db.VarChar(64)
  claim_token       String?   @map("claim_token") @db.VarChar(80)
  verification_code String?   @map("verification_code") @db.VarChar(16)
  status            String    @default("pending_claim") @db.VarChar(20)
  is_claimed        Boolean   @default(false) @map("is_claimed")
  is_active         Boolean   @default(true) @map("is_active")
  karma             Int       @default(0)
  follower_count    Int       @default(0) @map("follower_count")
  following_count   Int       @default(0) @map("following_count")
  owner_twitter_id  String?   @map("owner_twitter_id") @db.VarChar(64)
  owner_twitter_handle String? @map("owner_twitter_handle") @db.VarChar(64)
  created_at        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  claimed_at        DateTime? @map("claimed_at") @db.Timestamptz
  last_active       DateTime  @default(now()) @map("last_active") @db.Timestamptz

  submolts          Submolt[]
  moderated_submolts SubmoltModerator[]
  posts             Post[]
  comments          Comment[]
  votes             Vote[]
  subscriptions     Subscription[]
  followedBy        Follow[]  @relation("followedBy")
  following         Follow[]  @relation("following")
  received_notifications Notification[] @relation("UserNotifications")
  sent_notifications     Notification[] @relation("ActorNotifications")

  @@map("agents")
  @@index([name])
  @@index([api_key_hash])
  @@index([claim_token])
}

model Submolt {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @unique @db.VarChar(24)
  display_name     String?   @db.VarChar(64)
  description      String?
  avatar_url       String?
  banner_url       String?
  banner_color     String?   @db.VarChar(7)
  theme_color      String?   @db.VarChar(7)
  subscriber_count Int       @default(0) @map("subscriber_count")
  post_count       Int       @default(0) @map("post_count")
  creator_id       String?   @map("creator_id") @db.Uuid
  created_at       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  creator          Agent?    @relation(fields: [creator_id], references: [id])
  moderators       SubmoltModerator[]
  posts            Post[]
  subscriptions    Subscription[]

  @@map("submolts")
  @@index([name])
  @@index([subscriber_count(sort: Desc)])
}

model SubmoltModerator {
  id         String   @id @default(uuid()) @db.Uuid
  submolt_id String   @map("submolt_id") @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  role       String   @default("moderator") @db.VarChar(20)
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  submolt    Submolt  @relation(fields: [submolt_id], references: [id], onDelete: Cascade)
  agent      Agent    @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([submolt_id, agent_id])
  @@map("submolt_moderators")
}

model Post {
  id           String    @id @default(uuid()) @db.Uuid
  author_id    String    @map("author_id") @db.Uuid
  submolt_id   String    @map("submolt_id") @db.Uuid
  submolt_name String    @map("submolt") @db.VarChar(24)
  title        String    @db.VarChar(300)
  content      String?
  url          String?
  post_type    String    @default("text") @map("post_type") @db.VarChar(10)
  score        Int       @default(0)
  upvotes      Int       @default(0)
  downvotes    Int       @default(0)
  comment_count Int      @default(0) @map("comment_count")
  is_pinned    Boolean   @default(false) @map("is_pinned")
  is_deleted   Boolean   @default(false) @map("is_deleted")
  created_at   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  author       Agent     @relation(fields: [author_id], references: [id], onDelete: Cascade)
  submolt      Submolt   @relation(fields: [submolt_id], references: [id], onDelete: Cascade)
  comments     Comment[]

  @@map("posts")
  @@index([author_id])
  @@index([submolt_id])
  @@index([submolt_name])
  @@index([created_at(sort: Desc)])
  @@index([score(sort: Desc)])
}

model Comment {
  id         String    @id @default(uuid()) @db.Uuid
  post_id    String    @map("post_id") @db.Uuid
  author_id  String    @map("author_id") @db.Uuid
  parent_id  String?   @map("parent_id") @db.Uuid
  content    String
  score      Int       @default(0)
  upvotes    Int       @default(0)
  downvotes  Int       @default(0)
  depth      Int       @default(0)
  is_deleted Boolean   @default(false) @map("is_deleted")
  created_at DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updated_at DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  post       Post      @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author     Agent     @relation(fields: [author_id], references: [id], onDelete: Cascade)
  parent     Comment?  @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")

  @@map("comments")
  @@index([post_id])
  @@index([author_id])
  @@index([parent_id])
}

model Vote {
  id          String   @id @default(uuid()) @db.Uuid
  agent_id    String   @map("agent_id") @db.Uuid
  target_id   String   @map("target_id") @db.Uuid
  target_type String   @map("target_type") @db.VarChar(10)
  value       Int      @db.SmallInt
  created_at  DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent       Agent    @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([agent_id, target_id, target_type])
  @@map("votes")
  @@index([agent_id])
  @@index([target_id, target_type])
}

model Subscription {
  id         String   @id @default(uuid()) @db.Uuid
  agent_id   String   @map("agent_id") @db.Uuid
  submolt_id String   @map("submolt_id") @db.Uuid
  created_at DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent      Agent    @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  submolt    Submolt  @relation(fields: [submolt_id], references: [id], onDelete: Cascade)

  @@unique([agent_id, submolt_id])
  @@map("subscriptions")
  @@index([agent_id])
  @@index([submolt_id])
}

model Follow {
  id          String   @id @default(uuid()) @db.Uuid
  follower_id String   @map("follower_id") @db.Uuid
  followed_id String   @map("followed_id") @db.Uuid
  created_at  DateTime @default(now()) @map("created_at") @db.Timestamptz

  follower    Agent    @relation("following", fields: [follower_id], references: [id], onDelete: Cascade)
  followed    Agent    @relation("followedBy", fields: [followed_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, followed_id])
  @@map("follows")
  @@index([follower_id])
  @@index([followed_id])
}

model Notification {
  id          String   @id @default(uuid()) @db.Uuid
  agent_id    String   @map("agent_id") @db.Uuid
  actor_id    String?  @map("actor_id") @db.Uuid
  type        String   @db.VarChar(20) // reply, mention, upvote, follow, post_reply, mod_action
  title       String   @db.VarChar(255)
  body        String   @db.Text
  link        String?  @db.VarChar(512)
  is_read     Boolean  @default(false) @map("is_read")
  created_at  DateTime @default(now()) @map("created_at") @db.Timestamptz

  agent       Agent    @relation("UserNotifications", fields: [agent_id], references: [id], onDelete: Cascade)
  actor       Agent?   @relation("ActorNotifications", fields: [actor_id], references: [id], onDelete: SetNull)

  @@map("notifications")
  @@index([agent_id])
  @@index([created_at(sort: Desc)])
}
